/*-----------------------------------------------------------------------

File  : che_new_autoschedule.c

Author: Stephan Schulz

Contents

  Code that is automatically generated by 

Changes

<1> Tue May  2 22:07:17 GMT 2000
    Extracted from che_heuristics.c

-----------------------------------------------------------------------*/

#include "che_hcb.h"

#include "autoschedule_gen.vars"

void print_config_name(FILE* out, const char* config)
{
  DStr_p str = DStrAlloc();
  assert(strchr(config, '\n'));
  DStrAppendBuffer(str, (char*)config, strchr(config, '\n') - config);
  fprintf(out, "# config: %s\n", DStrView(str));
  DStrFree(str);
}

int str_distance(const char* a, const char* b)
{
  int dist = 0;
  while(*a && *b)
  {
    dist += *a == *b ? 0 : 1;
    a++;
    b++;
  }
  dist += strlen(a);
  dist += strlen(b);
  return dist;
}

const char* class_to_heuristic(const char* problem_category, const char** categories,
                        const char** configurations, int num_categories, 
                        HeuristicParms_p params)
{
  int i=0;
  int min_idx = -1;
  int min_dist = INT_MAX;
  for(; i<num_categories; i++)
  {
    int dist = str_distance(categories[i], problem_category);
    if(dist == 0)
    {
      break;
    }
    if (dist < min_dist)
    {
      min_dist = dist;  
      min_idx = i;
    }
  }
  const char* configuration =  configurations[i != num_categories ? i : min_idx];
  Scanner_p in = CreateScanner(StreamTypeInternalString, (char*)configuration, true, NULL, true);
  HeuristicParmsParseInto(in, params, true); 
  DestroyScanner(in);
  return configuration;
}

void HeuristicForRawCategory(const char* raw_category, HeuristicParms_p parms)
{
  const char* config = class_to_heuristic(raw_category, raw_categories, raw_confs, num_raw_categories, parms);
  fprintf(stderr, "# raw_category: %s\n", raw_category);
  print_config_name(stderr, config);
}

void HeuristicForCategory(const char* category, HeuristicParms_p parms)
{
  const char* config = class_to_heuristic(category, categories, confs, num_categories, parms);
  fprintf(stderr, "# category: %s\n", category);
  print_config_name(stderr, config);
}
